services:
  log-aggregator:
    build: ./log-aggregator
    ports:
      - "8080:8080"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # User Service Stack
  user-service:
    build: ./app-service
    volumes:
      - user_service_logs:/var/log/app
    environment:
      - SERVICE_NAME=user-service
      - PORT=3001
    ports:
      - "${USER_SERVICE_PORT:-3001}:3001"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3001/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  user-logging-sidecar:
    build: ./logging-sidecar
    volumes:
      - user_service_logs:/var/log/app:ro
    environment:
      - SERVICE_NAME=user-service
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - LOG_AGGREGATOR_URL=${LOG_AGGREGATOR_URL:-http://log-aggregator:8080/logs}
    depends_on:
      user-service:
        condition: service_healthy
      log-aggregator:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8081" ]
      interval: 10s
      timeout: 5s
      retries: 5

  user-metrics-sidecar:
    build: ./metrics-sidecar
    environment:
      - SERVICE_NAME=user-service
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - APP_METRICS_URL=http://user-service:3001/metrics
    ports:
      - "${USER_METRICS_SIDECAR_PORT:-9101}:9100"
    depends_on:
      user-service:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9100/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Product Service Stack
  product-service:
    build: ./app-service
    volumes:
      - product_service_logs:/var/log/app
    environment:
      - SERVICE_NAME=product-service
      - PORT=3002
    ports:
      - "${PRODUCT_SERVICE_PORT:-3002}:3002"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3002/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  product-logging-sidecar:
    build: ./logging-sidecar
    volumes:
      - product_service_logs:/var/log/app:ro
    environment:
      - SERVICE_NAME=product-service
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - LOG_AGGREGATOR_URL=${LOG_AGGREGATOR_URL:-http://log-aggregator:8080/logs}
    depends_on:
      product-service:
        condition: service_healthy
      log-aggregator:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8081" ]
      interval: 10s
      timeout: 5s
      retries: 5

  product-metrics-sidecar:
    build: ./metrics-sidecar
    environment:
      - SERVICE_NAME=product-service
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - APP_METRICS_URL=http://product-service:3002/metrics
    ports:
      - "${PRODUCT_METRICS_SIDECAR_PORT:-9102}:9100"
    depends_on:
      product-service:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9100/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Order Service Stack
  order-service:
    build: ./app-service
    volumes:
      - order_service_logs:/var/log/app
    environment:
      - SERVICE_NAME=order-service
      - PORT=3003
    ports:
      - "${ORDER_SERVICE_PORT:-3003}:3003"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3003/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  order-logging-sidecar:
    build: ./logging-sidecar
    volumes:
      - order_service_logs:/var/log/app:ro
    environment:
      - SERVICE_NAME=order-service
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - LOG_AGGREGATOR_URL=${LOG_AGGREGATOR_URL:-http://log-aggregator:8080/logs}
    depends_on:
      order-service:
        condition: service_healthy
      log-aggregator:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8081" ]
      interval: 10s
      timeout: 5s
      retries: 5

  order-metrics-sidecar:
    build: ./metrics-sidecar
    environment:
      - SERVICE_NAME=order-service
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - APP_METRICS_URL=http://order-service:3003/metrics
    ports:
      - "${ORDER_METRICS_SIDECAR_PORT:-9103}:9100"
    depends_on:
      order-service:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9100/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  user_service_logs:
  product_service_logs:
  order_service_logs:
